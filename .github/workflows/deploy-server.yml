name: Deploy Server

on:
  push:
    branches: [main]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-server.yml'
  pull_request:
    branches: [main]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-server.yml'

env:
  AWS_REGION: ap-northeast-2

permissions:
  id-token: write
  contents: read

jobs:
  server-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: server/package-lock.json
      
      - name: Cache node_modules
        uses: actions/cache@v3
        id: cache-server-deps
        with:
          path: server/node_modules
          key: server-deps-${{ hashFiles('server/package-lock.json') }}
          restore-keys: |
            server-deps-
      
      - name: Install dependencies
        if: steps.cache-server-deps.outputs.cache-hit != 'true'
        run: cd server && npm ci
      
      - run: cd server && npm run test

  server-build:
    runs-on: ubuntu-latest
    needs: server-test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
      
      - name: Restore node_modules
        uses: actions/cache@v3
        with:
          path: server/node_modules
          key: server-deps-${{ hashFiles('server/package-lock.json') }}
          restore-keys: |
            server-deps-
      
      - run: cd server && npm run build

  open-ssh:
    runs-on: ubuntu-latest
    needs: server-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions-ssh
          aws-region: ${{ env.AWS_REGION }}

      - name: Open SSH port
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr 0.0.0.0/0

  build-and-push-to-ecr:
    needs: server-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    outputs:
      server-image: ${{ steps.build-server.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions-build
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push server image to ECR
        id: build-server
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}/server
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f server/Dockerfile.prod server/
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest -f server/Dockerfile.prod server/

          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy:
    needs: [build-and-push-to-ecr, open-ssh]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload to S3
        run: |
          aws s3 cp deploy/docker-compose.server.prod.yml s3://coss-site-docker-compose/docker-compose.server.prod.yml

      - name: Download on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            aws s3 cp s3://coss-site-docker-compose/docker-compose.server.prod.yml /home/${{ secrets.EC2_USERNAME }}/deploy/docker-compose.server.prod.yml

      - name: Deploy docker-compose to EC2
        uses: appleboy/ssh-action@v1.0.0
        env:
          SERVER_IMAGE: ${{ needs.build-and-push-to-ecr.outputs.server-image }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          envs: SERVER_IMAGE
          script: |
            export AWS_DEFAULT_REGION=ap-northeast-2

            aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

            cd deploy
            
            cat > .env.prod << EOF
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USERNAME=advisor
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_DATABASE=coss
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            AWS_REGION=${{ env.AWS_REGION }}
            S3_BUCKET=${{ secrets.S3_BUCKET }}
            SERVER_IMAGE=$SERVER_IMAGE
            EOF

            docker-compose -f docker-compose.server.prod.yml down || true
            docker-compose --env-file .env.prod -f docker-compose.server.prod.yml pull
            docker-compose --env-file .env.prod -f docker-compose.server.prod.yml up -d

            echo "â³ Waiting for services to start..."
            sleep 60

            echo "ğŸ” Running health checks..."
            for i in {1..12}; do
              if curl -f http://localhost:3001/api/health > /dev/null 2>&1; then
                echo "âœ… API server is healthy"
                break
              else
                echo "â³ API server not ready, attempt $i/12"
                sleep 10
              fi
              if [ $i -eq 12 ]; then
                echo "âŒ API server health check failed"
                docker-compose -f docker-compose.server.prod.yml logs server
                exit 1
              fi
            done

            echo "ğŸ“Š Container status:"
            docker-compose -f docker-compose.server.prod.yml ps

            echo "ğŸ³ Deployed images:"
            echo "Server: $SERVER_IMAGE"

            echo "ğŸ‰ ECR deployment completed successfully!"

  close-ssh:
    needs: [open-ssh, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions-cleanup
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Close SSH port
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr 0.0.0.0/0

  server-ec2-health-check:
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: EC2 internal health check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            echo "ğŸ¥ Running EC2 internal health checks..."

            echo "ğŸ“Š Container status:"
            docker-compose -f deploy/docker-compose.server.prod.yml ps

            if curl -f http://localhost:3001/api/health > /dev/null 2>&1; then
              echo "âœ… Internal API server is healthy"
            else
              echo "âŒ Internal API server not accessible"
              docker-compose -f deploy/docker-compose.server.prod.yml logs server --tail=50
              exit 1
            fi

            echo "ğŸ’¾ System resources:"
            echo "Memory usage:"
            free -h
            echo "Disk usage:"
            df -h
            echo "Docker stats:"
            docker stats --no-stream

            echo "ğŸ‰ EC2 internal health check passed!"

  alb-health-check:
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: ALB endpoint health check
        run: |
          echo "ğŸ¥ Running ALB health checks..."

          for i in {1..30}; do
            if curl -f http://${{ secrets.ALB_DNS }} > /dev/null 2>&1; then
              echo "âœ… ALB root endpoint is healthy"
              break
            else
              echo "â³ ALB not ready, attempt $i/30"
              sleep 10
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ ALB health check failed"
              exit 1
            fi
          done

          if curl -f http://${{ secrets.ALB_DNS }}/api/health > /dev/null 2>&1; then
            echo "âœ… ALB API endpoint is healthy"
          else
            echo "âŒ ALB API endpoint not accessible"
            exit 1
          fi

          echo "ğŸ‰ All ALB health checks passed!"
          echo "ğŸŒ Application is live at: http://${{ secrets.ALB_DNS }}"
          echo "ğŸ”— API endpoint: http://${{ secrets.ALB_DNS }}/api/health"
