name: Deploy with ECR

# main branchì— push ë˜ëŠ” pull request ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
# (í•„ìš”ì— ë”°ë¼ ë¸Œëœì¹˜ ì´ë¦„ ë³€ê²½ ê°€ëŠ¥)
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# AWS_REGIONì€ ap-northeast-2ë¡œ ì„¤ì •
env:
  AWS_REGION: ap-northeast-2
  WEB_VERSION: v1.0.0

# git actions OIDC ì„¤ì •ìš© permissions
permissions:
  id-token: write   # OIDC í† í° ìš”ì²­ ê¶Œí•œ
  contents: read    # ì½”ë“œ ì²´í¬ì•„ì›ƒ ê¶Œí•œ

# ì›Œí¬í”Œë¡œìš° ì‹œì‘
jobs:
  # api serverì— ëŒ€í•œ test and build ì‹¤í–‰
  server-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: server/package-lock.json
      # npm ci ì‹œê°„ ë‹¨ì¶•ì„ ìœ„í•´ node_modules ìºì‹œ ì„¤ì •
      - name: Cache node_modules
        uses: actions/cache@v3
        id: cache-server-deps
        with:
          path: server/node_modules
          key: server-deps-${{ hashFiles('server/package-lock.json') }}
          restore-keys: |
            server-deps-
      
      - name: Install dependencies and test
        if: steps.cache-server-deps.outputs.cache-hit != 'true'
        run: cd server && npm ci
      
      - run: cd server && npm run test

  server-build:
    runs-on: ubuntu-latest
    needs: server-test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
      
      - name: Restore node_modules
        uses: actions/cache@v3
        with:
          path: server/node_modules
          key: server-deps-${{ hashFiles('server/package-lock.json') }}
          restore-keys: |
            server-deps-
      
      - run: cd server && npm run build

  # web serverì— ëŒ€í•œ test and build ì‹¤í–‰
  web-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: web/package-lock.json
      
      - name: Cache node_modules
        uses: actions/cache@v3
        id: cache-web-deps
        with:
          path: web/node_modules
          key: web-deps-${{ hashFiles('web/package-lock.json') }}
          restore-keys: |
            web-deps-
      
      - name: Install dependencies and build
        if: steps.cache-web-deps.outputs.cache-hit != 'true'
        run: cd web && npm ci
      
      - run: cd web && npm run test || echo "No tests found"

  web-build:
    runs-on: ubuntu-latest
    needs: web-test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
      
      - name: Restore node_modules
        uses: actions/cache@v3
        with:
          path: web/node_modules
          key: web-deps-${{ hashFiles('web/package-lock.json') }}
          restore-keys: |
            web-deps-
      
      - name: Build static site
        run: cd web && npm run build
      
      # ë¹Œë“œ ê²°ê³¼ë¬¼ì„ artifactë¡œ ì—…ë¡œë“œ
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: web/out/

  # web build ê²°ê³¼ë¬¼ì„ S3ì— ë°°í¬í•˜ëŠ” Job
  deploy-web-to-s3:
    runs-on: ubuntu-latest
    needs: [web-build]
    steps:
      # build ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web/out/
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions-s3
          aws-region: ${{ env.AWS_REGION }}
      
      # s3 root directoryì— ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: Deploy to S3
        run: |
          VERSION=${{ github.sha }}
          # ë²„ì „ë³„ ë°±ì—…
          aws s3 sync web/out/ s3://${{ secrets.WEB_S3_BUCKET_NAME }}/versions/$VERSION/ --delete
          # ë£¨íŠ¸ì— í˜„ì¬ ë²„ì „ ë°°í¬
          aws s3 sync web/out/ s3://${{ secrets.WEB_S3_BUCKET_NAME }}/ --delete
      
      # --paths "/*" ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ìºì‹œ íŒŒì¼ ë¬´íš¨í™”
      # Todo: directoryë³„ ë¬´íš¨í™”
      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.WEB_CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

  # server ec2ì— ëŒ€í•œ SSH í¬íŠ¸ ì—´ê¸° Job
  open-ssh:
    runs-on: ubuntu-latest
    needs: server-build
    steps:
      # OIDCë¥¼ ì‚¬ìš©í•˜ì—¬ AWS ìê²©ì¦ëª… êµ¬ì„±
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions-ssh
          aws-region: ${{ env.AWS_REGION }}

      # ê¸°ì¡´ SSH ê·œì¹™ ì •ë¦¬ í›„ ìƒˆ IPë¡œ SSH í¬íŠ¸ ì—´ê¸°
      - name: Clean up old SSH rules and open new
        run: |
          # í˜„ì¬ IP í™•ì¸
          RUNNER_IP=$(curl -s https://checkip.amazonaws.com)
          echo "ğŸ” Current runner IP: $RUNNER_IP"

          # ìƒˆ IPë¡œ ê·œì¹™ ì¶”ê°€
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${RUNNER_IP}/32

  # docker file build ë° ECR push
  build-and-push-to-ecr:
    needs: server-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    outputs:
      server-image: ${{ steps.build-server.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions-build
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push server image to ECR
        id: build-server
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_SERVER }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # ì„œë²„ ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f server/Dockerfile.prod server/
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest -f server/Dockerfile.prod server/

          # ECRì— í‘¸ì‹œ
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # ì¶œë ¥ ì„¤ì •
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy:
    needs: [build-and-push-to-ecr, open-ssh]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # localì˜ docker-compose.server.prod.ymlì„ EC2 rootë¡œ ë³µì‚¬
      - name: Copy docker-compose.prod.yml to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: "deploy/docker-compose.server.prod.yml"
          target: "/home/${{ secrets.EC2_USERNAME }}/"

      - name: Deploy docker-compose to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            # AWS ìê²©ì¦ëª… ì„¤ì • (EC2 IAM ì—­í•  ì‚¬ìš©)
            export AWS_DEFAULT_REGION=ap-northeast-2

            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            cat > .env.prod << EOF
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USERNAME=advicor
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_DATABASE=coss
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            AWS_REGION=${{ env.AWS_REGION }}
            S3_BUCKET=${{ secrets.S3_BUCKET }}
            REGISTRY_URL=${{ secrets.ECR_REGISTRY }}
            GITHUB_SHA=${{ github.sha }}
            EOF

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ì§€
            docker-compose -f docker-compose.server.prod.yml down || true

            # ìµœì‹  ì´ë¯¸ì§€ pull
            docker-compose --env-file .env.prod -f docker-compose.server.prod.yml pull

            # ì»¨í…Œì´ë„ˆ ì‹œì‘
            docker-compose --env-file .env.prod -f docker-compose.server.prod.yml up -d

            # ë°°í¬ ëŒ€ê¸°
            echo "â³ Waiting for services to start..."
            sleep 60

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Container status:"
            docker-compose -f docker-compose.prod.yml ps

            echo "ğŸ‰ ECR deployment completed successfully!"

  # needsì™€ ê´€ê³„ì—†ì´ ë¬´ì¡°ê±´ ì‹¤í–‰ë˜ëŠ” SSH ë‹«ê¸° Job
  close-ssh:
    needs: [open-ssh, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions-cleanup
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Get Runner IP and Close SSH port
        run: |
          RUNNER_IP=$(curl -s https://checkip.amazonaws.com)
          echo "Runner IP: $RUNNER_IP"
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${RUNNER_IP}/32

  sleep-30:
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: Wait for 30 seconds
        run: |
          echo "â³ Waiting for 30 seconds to allow services to stabilize..."
          sleep 30
          echo "âœ… Wait completed."

  server-ec2-health-check:
    needs: sleep-30
    runs-on: ubuntu-latest

    steps:
      - name: EC2 internal health check
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "Container status:"
            docker-compose -f docker-compose.prod.yml ps

            # ë‚´ë¶€ API ì„œë²„ í—¬ìŠ¤ì²´í¬
            if curl -f http://localhost:3001/api/health > /dev/null 2>&1; then
              echo "âœ… Internal API server is healthy"
            else
              echo "âŒ Internal API server not accessible"
              docker-compose -f docker-compose.prod.yml logs server --tail=50
              exit 1
            fi

            # ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸
            echo "ğŸ’¾ System resources:"
            echo "Memory usage:"
            free -h
            echo "Disk usage:"
            df -h
            echo "Docker stats:"
            docker stats --no-stream

            echo "ğŸ‰ EC2 internal health check passed!"

  alb-health-check:
    needs: sleep-30
    runs-on: ubuntu-latest

    steps:
      - name: ALB endpoint health check
        run: |
          echo "ğŸ¥ Running ALB health checks..."

          # ALB ì „ì²´ í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 5ë¶„ ëŒ€ê¸°)
          for i in {1..30}; do
            if curl -f http://${{ secrets.ALB_DNS }} > /dev/null 2>&1; then
              echo "âœ… ALB root endpoint is healthy"
              break
            else
              echo "â³ ALB not ready, attempt $i/30"
              sleep 10
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ ALB health check failed"
              exit 1
            fi
          done

          # API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          if curl -f http://${{ secrets.ALB_DNS }}/api/health > /dev/null 2>&1; then
            echo "âœ… ALB API endpoint is healthy"
          else
            echo "âŒ ALB API endpoint not accessible"
            exit 1
          fi

          echo "ğŸ‰ All ALB health checks passed!"

