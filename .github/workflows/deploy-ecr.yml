name: Deploy with ECR

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: ap-northeast-2

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: |
            server/package-lock.json
            web/package-lock.json

      - name: Install and test server
        run: |
          cd server
          npm ci
          npm run test

      - name: Install and test web
        run: |
          cd web
          npm ci
          npm run test || echo "No tests found"

      - name: Build server
        run: |
          cd server
          npm run build

      - name: Build web
        run: |
          cd web
          npm run build

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    outputs:
      server-image: ${{ steps.build-server.outputs.image }}
      web-image: ${{ steps.build-web.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_CICD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_CICD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push server image
        id: build-server
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_SERVER }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # ì„œë²„ ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f server/Dockerfile.prod server/
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest -f server/Dockerfile.prod server/

          # ECRì— í‘¸ì‹œ
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # ì¶œë ¥ ì„¤ì •
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Build and push web image
        id: build-web
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_WEB }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # ì›¹ ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f web/Dockerfile.prod web/
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest -f web/Dockerfile.prod web/

          # ECRì— í‘¸ì‹œ
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # ì¶œë ¥ ì„¤ì •
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  # SSH í¬íŠ¸ ì—´ê¸° Job  
  open-ssh:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_CICD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_CICD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Open SSH port
        run: |
          echo "ğŸ”“ Opening SSH port..."
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr 0.0.0.0/0

  deploy:
    needs: [build-and-push, open-ssh]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy docker-compose.prod.yml to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: "docker-compose.prod.yml"
          target: "/home/${{ secrets.EC2_USERNAME }}/"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            # AWS ìê²©ì¦ëª… ì„¤ì • (EC2 IAM ì—­í•  ì‚¬ìš©)
            export AWS_DEFAULT_REGION=ap-northeast-2

            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            cat > .env.prod << EOF
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USERNAME=advicor
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_DATABASE=coss
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            AWS_REGION=ap-northeast-2
            S3_BUCKET=${{ secrets.S3_BUCKET }}
            NEXT_PUBLIC_API_URL=http://${{ secrets.ALB_DNS }}/api
            SERVER_IMAGE=${{ needs.build-and-push.outputs.server-image }}
            WEB_IMAGE=${{ needs.build-and-push.outputs.web-image }}
            EOF

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ì§€
            docker-compose -f docker-compose.prod.yml down || true

            # ìµœì‹  ì´ë¯¸ì§€ pull
            docker-compose --env-file .env.prod -f docker-compose.prod.yml pull

            # ì»¨í…Œì´ë„ˆ ì‹œì‘
            docker-compose --env-file .env.prod -f docker-compose.prod.yml up -d

            # ë°°í¬ ëŒ€ê¸°
            echo "â³ Waiting for services to start..."
            sleep 60

            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ” Running health checks..."

            # API ì„œë²„ í—¬ìŠ¤ì²´í¬
            for i in {1..12}; do
              if curl -f http://localhost:3001/api/health > /dev/null 2>&1; then
                echo "âœ… API server is healthy"
                break
              else
                echo "â³ API server not ready, attempt $i/12"
                sleep 10
              fi
              if [ $i -eq 12 ]; then
                echo "âŒ API server health check failed"
                docker-compose -f docker-compose.prod.yml logs server
                exit 1
              fi
            done

            # ì›¹ ì„œë²„ í—¬ìŠ¤ì²´í¬
            for i in {1..12}; do
              if curl -f http://localhost:3000 > /dev/null 2>&1; then
                echo "âœ… Web server is healthy"
                break
              else
                echo "â³ Web server not ready, attempt $i/12"
                sleep 10
              fi
              if [ $i -eq 12 ]; then
                echo "âŒ Web server health check failed"
                docker-compose -f docker-compose.prod.yml logs web
                exit 1
              fi
            done

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Container status:"
            docker-compose -f docker-compose.prod.yml ps

            # ì´ë¯¸ì§€ ì •ë³´ ì¶œë ¥
            echo "ğŸ³ Deployed images:"
            echo "Server: ${{ needs.build-and-push.outputs.server-image }}"
            echo "Web: ${{ needs.build-and-push.outputs.web-image }}"

            echo "ğŸ‰ ECR deployment completed successfully!"

  # needsì™€ ê´€ê³„ì—†ì´ ë¬´ì¡°ê±´ ì‹¤í–‰ë˜ëŠ” SSH ë‹«ê¸° Job
  close-ssh:
    needs: [open-ssh, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_CICD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_CICD }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Close SSH port
        run: |
          echo "ğŸ”’ Closing SSH port..."
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr 0.0.0.0/0

  health-check:
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: External health check via ALB
        run: |
          echo "ğŸ¥ Running external health checks via ALB..."

          # ALB í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 5ë¶„ ëŒ€ê¸°)
          for i in {1..30}; do
            if curl -f http://${{ secrets.ALB_DNS }} > /dev/null 2>&1; then
              echo "âœ… ALB web endpoint is healthy"
              break
            else
              echo "â³ ALB not ready, attempt $i/30"
              sleep 10
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ ALB health check failed"
              exit 1
            fi
          done

          # API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          if curl -f http://${{ secrets.ALB_DNS }}/api/health > /dev/null 2>&1; then
            echo "âœ… ALB API endpoint is healthy"
          else
            echo "âŒ ALB API endpoint not accessible"
            exit 1
          fi

          echo "ğŸ‰ All external health checks passed!"
          echo "ğŸŒ Application is live at: http://${{ secrets.ALB_DNS }}"
          echo "ğŸ”— API endpoint: http://${{ secrets.ALB_DNS }}/api/health"
